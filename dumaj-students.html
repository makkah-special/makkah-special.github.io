<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø¨ÙˆØ§Ø¨Ø© Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ | Ù…Ø¯Ø±Ø³Ø© Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --primary:#1a3a5c;
    --accent:#e07020;
    --bg:#f5f2eb;
    --card:#ffffff;
    --border:#e0d8c8;
    --text:#1a1a2e;
    --muted:#5a6478;
    --green:#0d7a55;
    --green2:#10b981;
    --danger:#dc2626;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
  header{
    background:linear-gradient(135deg,#1a3a5c 0%,#0f2440 60%,#1a4a6c 100%);
    padding:14px 22px;display:flex;align-items:center;justify-content:space-between;gap:12px;
    border-bottom:3px solid var(--accent);
  }
  .h-left{display:flex;align-items:center;gap:12px}
  .h-ico{width:44px;height:44px;border-radius:12px;background:rgba(224,112,32,.14);border:1px solid rgba(224,112,32,.35);
    display:flex;align-items:center;justify-content:center;font-size:1.3rem}
  .h-title{color:#fff;font-family:'Tajawal',sans-serif;font-weight:900;font-size:1.05rem}
  .h-sub{color:rgba(255,255,255,.6);font-size:.76rem;margin-top:2px}
  .back-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.9);
    padding:8px 14px;border-radius:10px;text-decoration:none;font-weight:700;font-size:.82rem}
  .wrap{max-width:980px;margin:0 auto;padding:22px 16px 60px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 26px rgba(0,0,0,.06);overflow:hidden}
  .card-h{padding:14px 18px;border-bottom:1px solid var(--border);font-weight:900;color:var(--primary);background:linear-gradient(135deg,#fff,#fff7f0)}
  .pad{padding:18px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1;min-width:220px}
  label{display:block;font-size:.8rem;font-weight:800;color:var(--primary);margin:0 0 6px}
  input,select,textarea{
    width:100%;padding:11px 12px;border:1.5px solid var(--border);border-radius:12px;font-family:'Cairo',sans-serif;
    outline:none;background:#fff;font-size:.9rem;color:var(--text)
  }
  textarea{resize:vertical;min-height:80px}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(224,112,32,.12)}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:11px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:900;font-family:'Cairo',sans-serif;
    font-size:.9rem;text-decoration:none
  }
  .btn-primary{background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;box-shadow:0 8px 18px rgba(16,185,129,.25)}
  .btn-secondary{background:#fff;border:1px solid var(--border);color:var(--primary)}
  .btn-danger{background:#fff;border:1px solid #fecaca;color:var(--danger)}
  .muted{color:var(--muted);font-size:.82rem;line-height:1.8}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:.75rem}
  .pill-ok{background:#d1fae5;color:#065f46;border:1px solid #6ee7b7}
  .pill-warn{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .stu{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px;cursor:pointer;transition:.15s;display:flex;gap:10px;align-items:center}
  .stu:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.08);border-color:rgba(224,112,32,.6)}
  .av{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#fff7ed,#ffe5d0);display:flex;align-items:center;justify-content:center}
  .name{font-weight:900;color:var(--primary);font-size:.9rem;margin-bottom:2px}
  .meta{color:var(--muted);font-size:.78rem}
  .pin{font-weight:900;font-size:.74rem;background:#fff7ed;color:#9a3412;border:1px solid #fed7aa;border-radius:10px;padding:2px 8px}
  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
  .tabs{display:flex;gap:6px;background:#fff;border:1px solid var(--border);border-radius:14px;padding:6px;margin-bottom:14px}
  .tab{flex:1;padding:9px 8px;border:none;background:transparent;border-radius:10px;cursor:pointer;font-weight:900;color:var(--muted);font-size:.82rem}
  .tab.active{background:linear-gradient(135deg,var(--accent),#ff9a4a);color:#fff;box-shadow:0 8px 16px rgba(224,112,32,.18)}
  .pane{display:none}
  .pane.active{display:block}
  .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 16px;border-radius:12px;font-weight:800;font-size:.85rem;display:none;z-index:9999}
  .err{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:12px;padding:10px 12px;font-weight:800;font-size:.82rem;display:none;margin-top:10px}
  @media (max-width:640px){
    header{padding:12px 14px}
  }
</style>
</head>
<body>

<header>
  <div class="h-left">
    <div class="h-ico">ğŸ“˜</div>
    <div>
      <div class="h-title">Ø¨ÙˆØ§Ø¨Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ â€” Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ</div>
      <div class="h-sub">Ù…Ø¯Ø±Ø³Ø© Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© | Ù‚Ø³Ù… Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©</div>
    </div>
  </div>
  <a class="back-btn" href="index.html">â† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
</header>

<div class="wrap">

  <!-- LOGIN -->
  <div id="loginView" class="card">
    <div class="card-h">ğŸ” Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
    <div class="pad">
      <p class="muted">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø³Ø¬Ù„). Ù„Ù„Ù…Ø´Ø±Ù Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø´Ø±Ù.</p>
      <div class="row" style="margin-top:14px">
        <div class="col" style="max-width:320px">
          <label>Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
          <input id="pinInput" inputmode="numeric" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" oninput="this.value=this.value.replace(/[^0-9]/g,'')" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn btn-primary" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <div id="loginErr" class="err"></div>
      <div class="muted" style="margin-top:14px">
        âš™ï¸ <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙŠØ­ÙØ¸ ÙˆÙŠØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† <b>Supabase Database</b> Ù…Ø¨Ø§Ø´Ø±Ø© (ÙˆÙ„ÙŠØ³ Storage)ØŒ Ù„Ø°Ù„Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØµÙŠØ± Ø«Ø§Ø¨Øª Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©.
      </div>
    </div>
  </div>

  <!-- STUDENT -->
  <div id="studentView" style="display:none">
    <div class="card" style="margin-bottom:14px">
      <div class="card-h">ğŸ‘¤ Ù…Ù„Ù Ø§Ù„Ø·Ø§Ù„Ø¨</div>
      <div class="pad">
        <div class="topbar">
          <div>
            <div class="name" id="stuName">â€”</div>
            <div class="meta" id="stuMeta">â€”</div>
          </div>
          <div class="row">
            <span class="pill pill-ok" id="stuPinPill">PIN: â€”</span>
            <button class="btn btn-secondary" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>

        <div class="tabs">
          <button class="tab active" onclick="openStuTab('basic',this)">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <button class="tab" onclick="openStuTab('details',this)">Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
          <button class="tab" onclick="openStuTab('plan',this)">Ø§Ù„Ø®Ø·Ø© (Ù†Øµ)</button>
        </div>

        <div id="stu-basic" class="pane active">
          <div class="row">
            <div class="col"><label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label><input id="s_name" disabled></div>
            <div class="col"><label>Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„</label><input id="s_id" disabled></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col"><label>Ø§Ù„ØµÙ</label><input id="s_grade" disabled></div>
            <div class="col"><label>Ø¬ÙˆØ§Ù„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label><input id="s_phone" disabled></div>
          </div>
          <div class="muted" style="margin-top:10px">Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ­Ø¯Ù‘Ø«Ù‡Ø§ Ø§Ù„Ù…Ø´Ø±Ù Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….</div>
        </div>

        <div id="stu-details" class="pane">
          <div class="muted" style="margin-bottom:10px">ÙŠØ¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙƒÙ…Ø§ Ø£Ø¯Ø®Ù„Ù‡Ø§ Ø§Ù„Ù…Ø´Ø±Ù.</div>
          <div class="row">
            <div class="col"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input id="sd_birth" disabled></div>
            <div class="col"><label>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</label><input id="sd_nat" disabled></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col"><label>Ø§Ù„Ø¹Ù…Ø±</label><input id="sd_age" disabled></div>
            <div class="col"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="sd_addr" disabled></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col"><label>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø°ÙƒØ§Ø¡</label><input id="sd_iq" disabled></div>
            <div class="col"><label>Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØªØ±Ø¨ÙˆÙŠ</label><input id="sd_place" disabled></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col"><label>Ø§Ù„ØªØ´Ø®ÙŠØµ</label><textarea id="sd_diag" disabled></textarea></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col"><label>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØµØ­ÙŠ</label><textarea id="sd_health" disabled></textarea></div>
            <div class="col"><label>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†ÙØ³ÙŠ</label><textarea id="sd_psych" disabled></textarea></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col"><label>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</label><textarea id="sd_social" disabled></textarea></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col"><label>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¨ÙŠÙ† Ø¥Ø®ÙˆØªÙ‡</label><input id="sd_sib" disabled></div>
            <div class="col"><label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ</label><input id="sd_eco" disabled></div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col"><label>ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø¨</label><input id="sd_fedu" disabled></div>
            <div class="col"><label>ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ù…</label><input id="sd_medu" disabled></div>
          </div>
        </div>

        <div id="stu-plan" class="pane">
          <div class="muted" style="margin-bottom:10px">Ø§Ù„Ø®Ø·Ø© Ù‡Ù†Ø§ ÙƒÙ†Øµ (Ù…Ù…ÙƒÙ† Ù„Ø§Ø­Ù‚Ù‹Ø§ ØªØ±Ø¨Ø· PDF Ù…Ù† Storage).</div>
          <div id="planBox" class="card" style="border-radius:14px">
            <div class="pad">
              <div id="planText" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø© Ù†ØµÙŠØ©.</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="adminView" style="display:none">
    <div class="card" style="margin-bottom:14px">
      <div class="card-h">ğŸ”§ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</div>
      <div class="pad">
        <div class="topbar">
          <div class="muted">Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø§Ø¨ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ â€” Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Supabase DB</div>
          <div class="row">
            <span class="pill pill-warn" id="countPill">â€” Ø·Ø§Ù„Ø¨</span>
            <button class="btn btn-secondary" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>

        <div class="row" style="margin-bottom:12px">
          <div class="col" style="max-width:420px">
            <input id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ PIN..." oninput="renderList()">
          </div>
          <button class="btn btn-primary" onclick="openNew()">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
        </div>

        <div id="list" class="grid"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-h" id="formTitle">âœï¸ ØªØ¹Ø¯ÙŠÙ„ / Ø¥Ø¶Ø§ÙØ©</div>
      <div class="pad">
        <div class="row">
          <div class="col"><label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ *</label><input id="f_name"></div>
          <div class="col"><label>Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ (10 Ø£Ø±Ù‚Ø§Ù…) *</label><input id="f_id" maxlength="10" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,''); updatePinPreview();"></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col"><label>Ø§Ù„ØµÙ *</label><input id="f_grade" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø· / Ù¡"></div>
          <div class="col"><label>Ø¬ÙˆØ§Ù„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label><input id="f_phone" placeholder="05xxxxxxxx" inputmode="numeric"></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col" style="max-width:260px"><label>PIN (Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù…)</label><input id="f_pin" disabled></div>
          <div class="col"><label>Ø§Ù„Ø®Ø·Ø© (Ù†Øµ Ù…Ø®ØªØµØ±)</label><input id="f_plan_text" placeholder="Ù…Ø«Ø§Ù„: Ø£Ù‡Ø¯Ø§Ù Ù…Ù‡Ø§Ø±ÙŠØ© Ù…Ø®ØªØµØ±Ø©..."></div>
        </div>

        <div class="card" style="margin-top:14px;border-radius:16px">
          <div class="card-h">ğŸ“ Ø§Ù„ØªÙØ§ØµÙŠÙ„ (ÙƒÙ„Ù‡Ø§ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)</div>
          <div class="pad">
            <div class="row">
              <div class="col"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input id="d_birth" type="date"></div>
              <div class="col"><label>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</label><input id="d_nat"></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Ø§Ù„Ø¹Ù…Ø±</label><input id="d_age"></div>
              <div class="col"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="d_addr"></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø°ÙƒØ§Ø¡</label><input id="d_iq"></div>
              <div class="col"><label>Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØªØ±Ø¨ÙˆÙŠ</label><input id="d_place" placeholder="Ø§Ù„Ø¯Ù…Ø¬"></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Ø§Ù„ØªØ´Ø®ÙŠØµ</label><textarea id="d_diag"></textarea></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØµØ­ÙŠ</label><textarea id="d_health"></textarea></div>
              <div class="col"><label>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†ÙØ³ÙŠ</label><textarea id="d_psych"></textarea></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</label><textarea id="d_social"></textarea></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="col"><label>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¨ÙŠÙ† Ø¥Ø®ÙˆØªÙ‡</label><input id="d_sib"></div>
              <div class="col"><label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ</label><input id="d_eco"></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="col"><label>ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø¨</label><input id="d_fedu"></div>
              <div class="col"><label>ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ù…</label><input id="d_medu"></div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <button class="btn btn-primary" onclick="save()">ğŸ’¾ Ø­ÙØ¸</button>
          <button class="btn btn-danger" onclick="remove()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          <button class="btn btn-secondary" onclick="clearForm()">ØªÙØ±ÙŠØº</button>
        </div>
        <div id="formErr" class="err"></div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* =====================================================
   1) Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Supabase Ù‡Ù†Ø§ ÙÙ‚Ø·
   ===================================================== */
const SUPABASE_URL = "https://pyrxwqgapwjwhiskowhk.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5cnh3cWdhcHdqd2hpc2tvd2hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NDM3MjcsImV4cCI6MjA4NzExOTcyN30.nEJivQNdtbI8Vn7thWe29zHEOzK-Z8eZVQMnSyvKlII";
const ADMIN_PIN = "7410";

/* =====================================================
   2) Helpers
   ===================================================== */
const SB_TABLE = SUPABASE_URL + "/rest/v1/dumaj_students";
const H_GET = { "apikey": SUPABASE_ANON_KEY, "Authorization": "Bearer " + SUPABASE_ANON_KEY };
const H_WRITE = { ...H_GET, "Content-Type":"application/json", "Prefer":"resolution=merge-duplicates,return=minimal" };

let mode = "none";      // student | admin
let currentPin = null;  // student pin
let cache = {};         // pin -> row
let editingPin = null;  // admin form pin

function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=>t.style.display="none", 2200);
}
function showErr(el, msg){
  el.textContent = msg;
  el.style.display = "block";
}
function hideErr(el){ el.style.display="none"; el.textContent=""; }

/* =====================================================
   3) DB functions (Database only)
   ===================================================== */
async function dbGet(pin){
  const url = `${SB_TABLE}?pin=eq.${encodeURIComponent(pin)}&select=*`;
  const res = await fetch(url, { headers: H_GET });
  if(!res.ok) return null;
  const rows = await res.json();
  return rows && rows.length ? rows[0] : null;
}
async function dbList(){
  const url = `${SB_TABLE}?select=pin,name,grade,phone,id_full,details,plan_text&order=grade.asc,name.asc`;
  const res = await fetch(url, { headers: H_GET });
  if(!res.ok) return [];
  return await res.json();
}
async function dbUpsert(row){
  const url = `${SB_TABLE}?on_conflict=pin`;
  const payload = { ...row, updated_at: new Date().toISOString() };
  const res = await fetch(url, { method:"POST", headers:H_WRITE, body: JSON.stringify(payload)});
  if(!res.ok){
    const err = await res.text();
    throw new Error(err);
  }
}
async function dbDelete(pin){
  const url = `${SB_TABLE}?pin=eq.${encodeURIComponent(pin)}`;
  const res = await fetch(url, { method:"DELETE", headers:H_WRITE });
  if(!res.ok){
    const err = await res.text();
    throw new Error(err);
  }
}

/* =====================================================
   4) Login
   ===================================================== */
async function handleLogin(){
  const pin = document.getElementById("pinInput").value.trim();
  const err = document.getElementById("loginErr");
  hideErr(err);

  if(!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes("Ø¶Ø¹-Ù…ÙØªØ§Ø­")){
    showErr(err, "âš ï¸ Ù„Ø§Ø²Ù… ØªØ­Ø· anon key Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù (SUPABASE_ANON_KEY).");
    return;
  }

  if(pin === ADMIN_PIN){
    mode = "admin";
    await openAdmin();
    return;
  }

  if(pin.length !== 4){
    showErr(err, "âš ï¸ Ø£Ø¯Ø®Ù„ 4 Ø£Ø±Ù‚Ø§Ù….");
    return;
  }

  const row = await dbGet(pin);
  if(!row){
    showErr(err, "âŒ Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    return;
  }

  mode = "student";
  currentPin = pin;
  cache[pin] = row;
  openStudent(row);
}

function logout(){
  mode="none"; currentPin=null; editingPin=null;
  document.getElementById("pinInput").value="";
  document.getElementById("loginView").style.display="block";
  document.getElementById("studentView").style.display="none";
  document.getElementById("adminView").style.display="none";
}

/* =====================================================
   5) Student view
   ===================================================== */
function openStudent(row){
  document.getElementById("loginView").style.display="none";
  document.getElementById("adminView").style.display="none";
  document.getElementById("studentView").style.display="block";

  document.getElementById("stuName").textContent = row.name || "â€”";
  document.getElementById("stuMeta").textContent = `${row.grade || "â€”"} â€¢ ğŸ“˜ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙƒØ±ÙŠ`;
  document.getElementById("stuPinPill").textContent = `PIN: ${row.pin}`;

  document.getElementById("s_name").value = row.name || "";
  document.getElementById("s_id").value = row.id_full || "";
  document.getElementById("s_grade").value = row.grade || "";
  document.getElementById("s_phone").value = row.phone || "";

  const d = row.details || {};
  document.getElementById("sd_birth").value = d.birthdate || "";
  document.getElementById("sd_nat").value = d.nationality || "";
  document.getElementById("sd_age").value = d.age || "";
  document.getElementById("sd_addr").value = d.address || "";
  document.getElementById("sd_iq").value = d.iq || "";
  document.getElementById("sd_place").value = d.program_place || "";
  document.getElementById("sd_diag").value = d.diagnosis || "";
  document.getElementById("sd_health").value = d.status_health || "";
  document.getElementById("sd_psych").value = d.status_psych || "";
  document.getElementById("sd_social").value = d.status_social || "";
  document.getElementById("sd_sib").value = d.sibling_order || "";
  document.getElementById("sd_eco").value = d.economic_level || "";
  document.getElementById("sd_fedu").value = d.father_edu || "";
  document.getElementById("sd_medu").value = d.mother_edu || "";

  document.getElementById("planText").textContent = row.plan_text || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø© Ù†ØµÙŠØ©.";

  openStuTab("basic", document.querySelector(".tabs .tab"));
  window.scrollTo(0,0);
}

function openStuTab(id, btn){
  document.querySelectorAll("#studentView .pane").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll("#studentView .tab").forEach(t=>t.classList.remove("active"));
  document.getElementById("stu-"+id).classList.add("active");
  btn.classList.add("active");
}

/* =====================================================
   6) Admin view
   ===================================================== */
async function openAdmin(){
  document.getElementById("loginView").style.display="none";
  document.getElementById("studentView").style.display="none";
  document.getElementById("adminView").style.display="block";

  await refreshList();
  openNew();
  window.scrollTo(0,0);
}

async function refreshList(){
  const rows = await dbList();
  cache = {};
  rows.forEach(r=>cache[r.pin]=r);
  document.getElementById("countPill").textContent = `${rows.length} Ø·Ø§Ù„Ø¨`;
  renderList();
}

function renderList(){
  const q = (document.getElementById("searchInput").value || "").toLowerCase().trim();
  const list = Object.values(cache).filter(r =>
    (r.name || "").toLowerCase().includes(q) ||
    (r.pin || "").includes(q)
  );
  const el = document.getElementById("list");
  el.innerHTML = list.map(r=>`
    <div class="stu" onclick="openEdit('${r.pin}')">
      <div class="av">ğŸ§ </div>
      <div style="flex:1;min-width:0">
        <div class="name">${escapeHtml(r.name || "â€”")}</div>
        <div class="meta">${escapeHtml(r.grade || "â€”")} â€¢ <span class="pin">${r.pin}</span></div>
      </div>
      <div style="color:var(--muted);font-size:1.1rem">âœï¸</div>
    </div>
  `).join("");
}

function openNew(){
  editingPin = null;
  document.getElementById("formTitle").textContent = "â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨";
  clearForm();
}

function openEdit(pin){
  const r = cache[pin];
  if(!r) return;
  editingPin = pin;
  document.getElementById("formTitle").textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ (PIN: " + pin + ")";
  hideErr(document.getElementById("formErr"));

  document.getElementById("f_name").value = r.name || "";
  document.getElementById("f_id").value = r.id_full || "";
  document.getElementById("f_grade").value = r.grade || "";
  document.getElementById("f_phone").value = r.phone || "";
  document.getElementById("f_pin").value = r.pin || "";
  document.getElementById("f_plan_text").value = r.plan_text || "";

  const d = r.details || {};
  document.getElementById("d_birth").value = d.birthdate || "";
  document.getElementById("d_nat").value = d.nationality || "";
  document.getElementById("d_age").value = d.age || "";
  document.getElementById("d_addr").value = d.address || "";
  document.getElementById("d_iq").value = d.iq || "";
  document.getElementById("d_place").value = d.program_place || "";
  document.getElementById("d_diag").value = d.diagnosis || "";
  document.getElementById("d_health").value = d.status_health || "";
  document.getElementById("d_psych").value = d.status_psych || "";
  document.getElementById("d_social").value = d.status_social || "";
  document.getElementById("d_sib").value = d.sibling_order || "";
  document.getElementById("d_eco").value = d.economic_level || "";
  document.getElementById("d_fedu").value = d.father_edu || "";
  document.getElementById("d_medu").value = d.mother_edu || "";
}

function clearForm(){
  ["f_name","f_id","f_grade","f_phone","f_plan_text",
   "d_birth","d_nat","d_age","d_addr","d_iq","d_place",
   "d_diag","d_health","d_psych","d_social","d_sib","d_eco","d_fedu","d_medu"
  ].forEach(id=>document.getElementById(id).value="");
  document.getElementById("f_pin").value = "";
  hideErr(document.getElementById("formErr"));
}

function updatePinPreview(){
  const id = document.getElementById("f_id").value.trim();
  document.getElementById("f_pin").value = id.length >= 4 ? id.slice(-4) : "";
}

/* =====================================================
   7) Save / Delete
   ===================================================== */
async function save(){
  const err = document.getElementById("formErr");
  hideErr(err);

  const name = document.getElementById("f_name").value.trim();
  const id_full = document.getElementById("f_id").value.trim();
  const grade = document.getElementById("f_grade").value.trim();
  const phone = document.getElementById("f_phone").value.trim();
  const pin = (id_full.length >= 4) ? id_full.slice(-4) : "";

  if(!name || !id_full || !grade){
    showErr(err, "âš ï¸ Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ø³Ø¬Ù„ + Ø§Ù„ØµÙ Ù…Ø·Ù„ÙˆØ¨Ø©.");
    return;
  }
  if(pin.length !== 4){
    showErr(err, "âš ï¸ Ø§Ù„Ø³Ø¬Ù„ Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ØµØ­ÙŠØ­ Ø¹Ø´Ø§Ù† Ù†Ø·Ù„Ø¹ PIN.");
    return;
  }

  const details = {
    birthdate: document.getElementById("d_birth").value || "",
    nationality: document.getElementById("d_nat").value.trim() || "",
    age: document.getElementById("d_age").value.trim() || "",
    address: document.getElementById("d_addr").value.trim() || "",
    iq: document.getElementById("d_iq").value.trim() || "",
    program_place: document.getElementById("d_place").value.trim() || "",
    diagnosis: document.getElementById("d_diag").value.trim() || "",
    status_health: document.getElementById("d_health").value.trim() || "",
    status_psych: document.getElementById("d_psych").value.trim() || "",
    status_social: document.getElementById("d_social").value.trim() || "",
    sibling_order: document.getElementById("d_sib").value.trim() || "",
    economic_level: document.getElementById("d_eco").value.trim() || "",
    father_edu: document.getElementById("d_fedu").value.trim() || "",
    mother_edu: document.getElementById("d_medu").value.trim() || ""
  };

  const row = {
    pin,
    name,
    id_full,
    grade,
    phone,
    plan_text: document.getElementById("f_plan_text").value.trim() || "",
    details
  };

  try{
    toast("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...");
    await dbUpsert(row);
    toast("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
    await refreshList();
    openEdit(pin);
  }catch(e){
    console.error(e);
    showErr(err, "âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. Ø§ÙØªØ­ Console ÙˆØ´ÙˆÙ Ø§Ù„Ø®Ø·Ø£. (ØºØ§Ù„Ø¨Ù‹Ø§ RLS Ø£Ùˆ anon key)");
  }
}

async function remove(){
  const err = document.getElementById("formErr");
  hideErr(err);
  const pin = editingPin || document.getElementById("f_pin").value.trim();
  if(!pin){
    showErr(err, "âš ï¸ Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }
  if(!confirm("âš ï¸ Ù…ØªØ£ÙƒØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) return;

  try{
    toast("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...");
    await dbDelete(pin);
    toast("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
    await refreshList();
    openNew();
  }catch(e){
    console.error(e);
    showErr(err, "âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù. (RLS Ø£Ùˆ anon key)");
  }
}

/* =====================================================
   8) small utils
   ===================================================== */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
</script>

</body>
</html>
